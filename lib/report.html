<html>
  <head>
    <title>Dependency Licenses</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      table {
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      tr:nth-child(even) {
        background: #f4fbfd;
      }
      fieldset {
        margin-bottom: 1rem;
      }
      legend {
        font-weight: bold;
      }

      .license-filters {
        column-count: 3;
        column-gap: 20px;
        border-top: 1px solid #ccc;
        padding-top: 7px;
      }
      label {
        display: block;
        margin-bottom: 5px;
      }
      .type-cell {
        white-space: nowrap;
        gap: 5px;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        color: white;
        font-size: 0.7rem;
        text-align: center;
        text-transform: capitalize;
      }
      .pill.direct {
        background-color: #4caf50;
      }
      .pill.transitive {
        background-color: #2196f3;
      }
      .pill.dev {
        background-color: #ff9800;
      }
      thead {
        background-color: #f2f2f2;
        position: sticky;
        top: 0;
      }
      code {
        display: block;
      }
      .unknown-license {
        color: red;
        font-weight: bold;
      }
      .registry-link {
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <h1>Dependency Licenses</h1>
    <form>
      <fieldset>
        <legend>Filter by License</legend>
        <label>
          <input id="selectAll" type="checkbox" value="ALL" checked />
          Select All
        </label>
        <div class="license-filters"></div>
      </fieldset>
      <fieldset>
        <legend>Filter by Dependency Type</legend>
        <label>
          <input id="filterDirect" type="checkbox" value="direct" checked />
          Direct <span id="directCount"></span>
        </label>
        <label>
          <input id="filterTransitive" type="checkbox" value="transitive" checked />
          Transitive <span id="transitiveCount"></span>
        </label>
      </fieldset>
    </form>
    <table>
      <thead>
        <tr>
          <th>Package</th>
          <th>Link</th>
          <th>Version</th>
          <th>License</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody id="license-details-body"></tbody>
    </table>
    <template id="filter-template">
      <label>
        <input type="checkbox" value="" checked />
        <span class="license-name-count">{{license}} ({{count}})</span>
      </label>
    </template>
    <template id="row-template">
      <tr data-license="{{license}}" data-type="{{type}}">
        <td class="pkg-name">
          <details>
            <summary>{{name}}</summary>
            <span> {{tree}} </span>
          </details>
        </td>
        <td>
          <a class="registry-link" target="_blank" href="https://www.npmjs.com/package/{{name}}">npm</a>
        </td>
        <td class="pkg-version">{{version}}</td>
        <td class="pkg-license">{{licenseLink}}</td>
        <td class="type-cell">
          <span class="pill {{type}}">{{type}}</span>
          <span class="pill dev">dev</span>
        </td>
      </tr>
    </template>
    <script>
			const UNKNOWN_LICENSE = "UNKNOWN";
      /**
       * @type {Record<string, number>}
       */
      let licenseCount = { MIT: 12, "Apache-2.0": 8, "GPL-3.0": 3, UNKNOWN: 5 };
      /* {{licenseCount}} */

      let directCount = 5;
      let transitiveCount = 23;
      /* {{directCount}} */
      /* {{transitiveCount}} */

      let licenseData = [
        {
          name: "@11ty/dependency-tree",
          license: "MIT",
          isDev: false,
          fromDev: false,
          version: "4.0.0",
          type: "transitive",
          tree: ["@11ty/eleventy@3.1.2", "@11ty/dependency-tree@4.0.0"],
        },
        {
          name: "@11ty/dependency-tree-esm",
          license: "MIT",
          isDev: false,
          fromDev: false,
          version: "2.0.0",
          type: "transitive",
          tree: ["@11ty/eleventy@3.1.2", "@11ty/dependency-tree-esm@2.0.0"],
        },
        {
          name: "@11ty/eleventy",
          license: "MIT",
          isDev: true,
          fromDev: false,
          version: "3.1.2",
          type: "direct",
          tree: ["@11ty/eleventy@3.1.2"],
        },
        {
          name: "@11ty/eleventy-dev-server",
          license: "MIT",
          isDev: false,
          fromDev: false,
          version: "2.0.8",
          type: "transitive",
          tree: ["@11ty/eleventy@3.1.2", "@11ty/eleventy-dev-server@2.0.8"],
        },
        {
          name: "@11ty/eleventy-fetch",
          license: "MIT",
          isDev: false,
          fromDev: false,
          version: "5.1.0",
          type: "transitive",
          tree: ["@11ty/eleventy-img@6.0.4", "@11ty/eleventy-fetch@5.1.0"],
        },
        {
          name: "@11ty/eleventy-img",
          license: "MIT",
          isDev: true,
          fromDev: false,
          version: "6.0.4",
          type: "direct",
          tree: ["@11ty/eleventy-img@6.0.4"],
        },
        {
          name: "@11ty/eleventy-navigation",
          license: "MIT",
          isDev: true,
          fromDev: false,
          version: "1.0.4",
          type: "direct",
          tree: ["@11ty/eleventy-navigation@1.0.4"],
        },
        {
          name: "@11ty/eleventy-plugin-bundle",
          license: "MIT",
          isDev: true,
          fromDev: false,
          version: "3.0.6",
          type: "direct",
          tree: ["@11ty/eleventy@3.1.2", "@11ty/eleventy-plugin-bundle@3.0.6"],
        },
        {
          name: "@11ty/eleventy-plugin-rss",
          license: "MIT",
          isDev: true,
          fromDev: false,
          version: "2.0.4",
          type: "direct",
          tree: ["@11ty/eleventy-plugin-rss@2.0.4"],
        },
        {
          name: "@11ty/eleventy-plugin-syntaxhighlight",
          license: "MIT",
          isDev: true,
          fromDev: false,
          version: "5.0.2",
          type: "direct",
          tree: ["@11ty/eleventy-plugin-syntaxhighlight@5.0.2"],
        },
        {
          name: "@11ty/eleventy-utils",
          license: "MIT",
          isDev: false,
          fromDev: false,
          version: "2.0.7",
          type: "transitive",
          tree: ["@11ty/eleventy@3.1.2", "@11ty/eleventy-utils@2.0.7"],
        },
      ];
      /* {{licenseData}} */

      function renderFilters() {
        const template = document.getElementById("filter-template");
        const container = document.querySelector(".license-filters");
        container.innerHTML = "";
        for (const [license, count] of Object.entries(licenseCount)) {
          const clone = template.content.cloneNode(true);
          clone.querySelector("input").value = license;
          clone.querySelector("input").checked = true;
          clone.querySelector(".license-name-count").innerHTML = `${license} (${count})`;
          clone.querySelector("label").className = license === "UNKNOWN" ? "unknown-license" : "";
          container.appendChild(clone);
        }
        document.getElementById("directCount").textContent = `(${directCount})`;
        document.getElementById("transitiveCount").textContent = `(${transitiveCount})`;
      }
      renderFilters();

      /**
       * Create an SPDX license link
       * @param {string} id - License identifier
       * @returns {string} HTML link to SPDX license page
       */
      const spdxLink = (id) =>
        `<a target="_blank" href="https://spdx.org/licenses/${id}.html">${id}</a>`;
      const spdxOperators = ["AND", "OR", "WITH"];
      const spdxRegex = new RegExp(`\\s+(${spdxOperators.join("|")})\\s+`, "g");

      /**
       * Linkify a license name if possible to https://spdx.org/licenses/
       *
       * There are packages that handle parsing SPDX expressions
       * (like https://www.npmjs.com/package/spdx-expression-parse)
       * but because I want to keep this script dependency-free,
       * I'm implementing a simple parser that handles the most common cases.
       *
       * @param {string} license
       * @returns {string} HTML-formatted license with links
       */
      function linkifyLicense(license = "") {
        if (
          !license ||
          license === UNKNOWN_LICENSE ||
          license.includes("SEE LICENSE") ||
          license === "UNLICENSED"
        ) {
          return license;
        }

        // Handle complex license expressions
        // (BSD-2-Clause OR MIT OR Apache-2.0)
        // (MIT AND CC0-1.0)
        // (GPL-2.0+ WITH Bison-exception-2.2)
        // for now it will not handle nested parentheses: (MIT AND (LGPL-2.1+ AND BSD-3-Clause))
        if (license.startsWith("(") && license.endsWith(")")) {
          // remove the outer parentheses and process the inner expression
          const inner = license.slice(1, -1);

          // if the inner expressions still contains parentheses, we won't try to parse it further
          if (inner.includes("(")) {
            // just link them to the main list of licenses and they can search there
            return `<a target="_blank" href="https://spdx.org/licenses/">${license}</a>`;
          }

          // split by AND/OR/WITH and linkify each part and bring it back to
          // together with the original operator
          return inner
            .split(spdxRegex)
            .filter((x) => !!x.trim())
            .map((part) => {
              part = part.trim();
              if (spdxOperators.includes(part)) {
                return ` ${part} `;
              }
              return spdxLink(part);
            })
            .join("");
        }

        return spdxLink(license);
      }

			function renderRows() {
				const template = document.getElementById("row-template");
				const tbody = document.getElementById("license-details-body");
				tbody.innerHTML = "";
				for (const info of licenseData) {
					const clone = template.content.cloneNode(true);
					clone.querySelector("tr").setAttribute("data-license", info.license);
					clone.querySelector("tr").setAttribute("data-type", info.type);
					clone.querySelector("summary").textContent = info.name;
					clone.querySelector("details span").innerHTML = "";
					info.tree.forEach((item, i) => {
						const code = document.createElement("code");
						code.style.paddingLeft = `${i * 20}px`;
						code.textContent = item;
						clone.querySelector("details span").appendChild(code);
					});
					clone.querySelector(".registry-link").href = `https://www.npmjs.com/package/${info.name}`;
					clone.querySelector("td.pkg-version").textContent = info.version;
					clone.querySelector("td.pkg-license").innerHTML = linkifyLicense(info.license);
					clone.querySelector(".type-cell .pill:first-child").textContent = info.type;
					clone.querySelector(".type-cell .pill:first-child").classList.add(info.type);
					if (!info.isDev) {
						clone.querySelector(".type-cell").removeChild(
							clone.querySelector(".type-cell .pill.dev")
						);
					}
					tbody.appendChild(clone);
				}
			}
			renderRows();

      /**
       * This file contains the client-side JavaScript for filtering the license table.
       * It will be inlined into the HTML report generated by buildHtmlReport.
       */
      const $ = document.querySelector.bind(document);
      const $$ = document.querySelectorAll.bind(document);

      function filterTable() {
        setTimeout(() => {
          /**
           * @type {NodeListOf<HTMLInputElement>}
           */
          const checkedLicenseFilters = $$('.license-filters input[type="checkbox"]:checked');

          const checkedLicenses = Array.from(checkedLicenseFilters).map((cb) => cb.value);

          const showDirect = /** @type {HTMLInputElement} */ ($("#filterDirect")).checked;

          const showTransitive = /** @type {HTMLInputElement} */ ($("#filterTransitive")).checked;

          /**
           * @type {NodeListOf<HTMLTableRowElement>}
           */
          const rows = $$("#license-details-body tr");
          rows.forEach((row) => {
            const license = row.getAttribute("data-license");
            if (
              license &&
              checkedLicenses.includes(license) &&
              ((showDirect && row.getAttribute("data-type") === "direct") ||
                (showTransitive && row.getAttribute("data-type") === "transitive"))
            ) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        }, 0);
      }

      function attachFilterListeners() {
        /**
         * @type {NodeListOf<HTMLInputElement>}
         */
        const checkboxes = $$('.license-filters input[type="checkbox"]');
        checkboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", () => {
            filterTable();
          });
        });

        $("#selectAll")?.addEventListener("change", (e) => {
          const checked = /** @type {HTMLInputElement} */ (e.target)?.checked;
          checkboxes.forEach((checkbox) => {
            checkbox.checked = checked;
          });
          filterTable();
        });

        $("#filterDirect")?.addEventListener("change", (e) => {
          filterTable();
        });

        $("#filterTransitive")?.addEventListener("change", (e) => {
          filterTable();
        });
      }

      document.addEventListener("DOMContentLoaded", attachFilterListeners);
    </script>
  </body>
</html>
